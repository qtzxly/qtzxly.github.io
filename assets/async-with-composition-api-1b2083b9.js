import{u as o,c as n,w as t,_ as r,o as c,a as s,b as a}from"./app-65cc71ad.js";const p=s("div",{class:"prose m-auto slide-enter-content"},[s("p",null,"There is a major caveat when working with asynchronous functions in Vue Composition API, that I believe many of you have ever come across. I have acknowledged it for a while from somewhere, but every time I want to have a detailed reference and share to others, I can’t find it’s documented anywhere. So, I am thinking about writing one, with a detailed explanation while sorting out the possible solutions for you."),s("ul",null,[s("li",null,[s("a",{href:"#the-problem"},"The Problem")]),s("li",null,[s("a",{href:"#the-mechanism"},"The Mechanism")]),s("li",null,[s("a",{href:"#the-limitation"},"The Limitation")]),s("li",null,[s("a",{href:"#the-solutions"},"The Solutions")])]),s("h2",{id:"the-problem",tabindex:"-1"},[a("The Problem "),s("a",{class:"header-anchor",href:"#the-problem","aria-hidden":"true"},"#")]),s("p",null,[a("When using asynchronous "),s("code",null,"setup()"),a(", "),s("strong",null,[a("you have to use effects and lifecycle hooks before the first "),s("code",null,"await"),a(" statement.")]),a(" ("),s("a",{href:"https://github.com/vuejs/rfcs/discussions/234",target:"_blank",rel:"noopener"},"details"),a(")")]),s("p",null,"For example:"),s("pre",{class:"shiki shiki-themes vitesse-light vitesse-dark",style:{"background-color":"#ffffff","--s-dark-bg":"#121212",color:"#393a34","--s-dark":"#dbd7caee"},tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}},"import"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," {"),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," ref"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},","),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," watch"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},","),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," onMounted"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},","),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," onUnmounted"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," }"),s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}}," from"),s("span",{style:{color:"#B5695999","--s-dark":"#C98A7D99"}}," '"),s("span",{style:{color:"#B56959","--s-dark":"#C98A7D"}},"vue"),s("span",{style:{color:"#B5695999","--s-dark":"#C98A7D99"}},"'")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}},"export"),s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}}," default"),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," defineAsyncComponent"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"({")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"  async"),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," setup"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"() {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"    const "),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"counter"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ="),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," ref"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"("),s("span",{style:{color:"#2F798A","--s-dark":"#4C9A91"}},"0"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},")")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"    watch"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"("),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"counter"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},", () => "),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"console"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"."),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"log"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"("),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"counter"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"."),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"value"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"))")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A0ADA0","--s-dark":"#758575DD"}},"    // OK!")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"    onMounted"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"(() => "),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"console"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"."),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"log"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"("),s("span",{style:{color:"#B5695999","--s-dark":"#C98A7D99"}},"'"),s("span",{style:{color:"#B56959","--s-dark":"#C98A7D"}},"Mounted"),s("span",{style:{color:"#B5695999","--s-dark":"#C98A7D99"}},"'"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"))")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A0ADA0","--s-dark":"#758575DD"}},"    // the await statement")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}},"    await"),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," someAsyncFunction"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"() "),s("span",{style:{color:"#A0ADA0","--s-dark":"#758575DD"}},"// <-----------")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A0ADA0","--s-dark":"#758575DD"}},"    // does NOT work!")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"    onUnmounted"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"(() => "),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"console"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"."),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"log"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"("),s("span",{style:{color:"#B5695999","--s-dark":"#C98A7D99"}},"'"),s("span",{style:{color:"#B56959","--s-dark":"#C98A7D"}},"Unmounted"),s("span",{style:{color:"#B5695999","--s-dark":"#C98A7D99"}},"'"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"))")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A0ADA0","--s-dark":"#758575DD"}},"    // still works, but does not auto-dispose ")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A0ADA0","--s-dark":"#758575DD"}},"    // after the component is destroyed (memory leak!)")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"    watch"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"("),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"counter"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},", () => "),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"console"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"."),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"log"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"("),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"counter"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"."),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"value"),s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}}," *"),s("span",{style:{color:"#2F798A","--s-dark":"#4C9A91"}}," 2"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"))")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#999999","--s-dark":"#666666"}},"  }")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#999999","--s-dark":"#666666"}},"})")]),a(`
`),s("span",{class:"line"})])]),s("p",null,[a("After the "),s("code",null,"await"),a(" statement,")]),s("p",null,[a("the following functions will be "),s("strong",null,"limited"),a(" (no auto-dispose):")]),s("ul",null,[s("li",null,[s("code",null,"watch"),a(" / "),s("code",null,"watchEffect")]),s("li",null,[s("code",null,"computed")]),s("li",null,[s("code",null,"effect")])]),s("p",null,[a("the following functions will "),s("strong",null,"not work"),a(":")]),s("ul",null,[s("li",null,[s("code",null,"onMounted"),a(" / "),s("code",null,"onUnmounted"),a(" / "),s("code",null,"onXXX")]),s("li",null,[s("code",null,"provide"),a(" / "),s("code",null,"inject")]),s("li",null,[s("code",null,"getCurrentInstance")]),s("li",null,"…")]),s("h2",{id:"the-mechanism",tabindex:"-1"},[a("The Mechanism "),s("a",{class:"header-anchor",href:"#the-mechanism","aria-hidden":"true"},"#")]),s("p",null,[a("Let’s take the "),s("code",null,"onMounted"),a(" API as an example. As we know, "),s("code",null,"onMounted"),a(" is a hook that registers a listener when the current component gets mounted. Notice that "),s("code",null,"onMounted"),a(" (along with other composition APIs) are "),s("strong",null,"global"),a(', for what I mean "global" is that it can be imported and called anywhere - there is '),s("strong",null,"no local context"),a(" bound to it.")]),s("pre",{class:"shiki shiki-themes vitesse-light vitesse-dark",style:{"background-color":"#ffffff","--s-dark-bg":"#121212",color:"#393a34","--s-dark":"#dbd7caee"},tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#A0ADA0","--s-dark":"#758575DD"}},"// local: `onMounted` is a method of `component` that bound to it")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"component"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"."),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"onMounted"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"("),s("span",{style:{color:"#A0ADA0","--s-dark":"#758575DD"}},"/* ... */"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},")")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A0ADA0","--s-dark":"#758575DD"}},"// global: `onMounted` can be called without context")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"onMounted"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"("),s("span",{style:{color:"#A0ADA0","--s-dark":"#758575DD"}},"/* ... */"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},")")]),a(`
`),s("span",{class:"line"})])]),s("p",null,[a("So, how does "),s("code",null,"onMounted"),a(" know what component is being mounted?")]),s("p",null,"Vue takes an interesting approach to solve this. It uses an internal variable to record the current component instance. There is a simplified code:"),s("p",null,"When Vue mounts a component, it stores the instance in a global variable. When hooks been called inside the setup function, it will use the global variable to get the current component instance."),s("pre",{class:"shiki shiki-themes vitesse-light vitesse-dark",style:{"background-color":"#ffffff","--s-dark-bg":"#121212",color:"#393a34","--s-dark":"#dbd7caee"},tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"let"),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," currentInstance"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ="),s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}}," null")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A0ADA0","--s-dark":"#758575DD"}},"// (pseudo code)")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}},"export"),s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}}," function"),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," mountComponent"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"("),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"component"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},")"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"  const"),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," instance"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ="),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," createComponent"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"("),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"component"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},")")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A0ADA0","--s-dark":"#758575DD"}},"  // hold the previous instance")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"  const"),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," prev"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ="),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," currentInstance")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A0ADA0","--s-dark":"#758575DD"}},"  // set the instance to global")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"  currentInstance"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ="),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," instance")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A0ADA0","--s-dark":"#758575DD"}},"  // hooks called inside the `setup()` will have")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A0ADA0","--s-dark":"#758575DD"}},"  // the `currentInstance` as the context")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"  component"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"."),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"setup"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"()"),s("span",{style:{color:"#393A34","--s-dark":"#DBD7CAEE"}}," ")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A0ADA0","--s-dark":"#758575DD"}},"  // restore the previous instance")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"  currentInstance"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ="),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," prev"),s("span",{style:{color:"#393A34","--s-dark":"#DBD7CAEE"}}," ")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#999999","--s-dark":"#666666"}},"}")]),a(`
`),s("span",{class:"line"})])]),s("p",null,[a("A simplified "),s("code",null,"onMounted"),a(" implementation would be like:")]),s("pre",{class:"shiki shiki-themes vitesse-light vitesse-dark",style:{"background-color":"#ffffff","--s-dark-bg":"#121212",color:"#393a34","--s-dark":"#dbd7caee"},tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#A0ADA0","--s-dark":"#758575DD"}},"// (pseudo code)")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}},"export"),s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}}," function"),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," onMounted"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"("),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"fn"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},")"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}},"  if"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ("),s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"!"),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"currentInstance"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},")"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"    warn"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"("),s("span",{style:{color:"#B5695999","--s-dark":"#C98A7D99"}},"`"),s("span",{style:{color:"#B56959","--s-dark":"#C98A7D"}},`"onMounted" can't be called outside of component setup()`),s("span",{style:{color:"#B5695999","--s-dark":"#C98A7D99"}},"`"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},")")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}},"    return")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#999999","--s-dark":"#666666"}},"  }")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A0ADA0","--s-dark":"#758575DD"}},"  // bound listener to the current instance")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"  currentInstance"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"."),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"onMounted"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"("),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"fn"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},")")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#999999","--s-dark":"#666666"}},"}")]),a(`
`),s("span",{class:"line"})])]),s("p",null,[a("With this approach, as long as the "),s("code",null,"onMounted"),a(" is called inside the component "),s("code",null,"setup()"),a(", it will be able to get the instance of the current component.")]),s("h2",{id:"the-limitation",tabindex:"-1"},[a("The Limitation "),s("a",{class:"header-anchor",href:"#the-limitation","aria-hidden":"true"},"#")]),s("p",null,"So far so good, but what’s wrong with asynchronous functions?"),s("p",null,[a("The implementation would work based on the fact that JavaScript is "),s("strong",null,"single-threaded"),a(". Single thread makes sure the following statements will be executed right next to each other, which in other words, there is no one could accidentally modify the "),s("code",null,"currentInstance"),a(" at the same time (a.k.a. it’s "),s("a",{href:"https://stackoverflow.com/questions/52196678/what-are-atomic-operations-for-newbies",target:"_blank",rel:"noopener"},"atomic"),a(").")]),s("pre",{class:"shiki shiki-themes vitesse-light vitesse-dark",style:{"background-color":"#ffffff","--s-dark-bg":"#121212",color:"#393a34","--s-dark":"#dbd7caee"},tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"currentInstance"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ="),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," instance")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"component"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"."),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"setup"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"()"),s("span",{style:{color:"#393A34","--s-dark":"#DBD7CAEE"}}," ")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"currentInstance"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ="),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," prev"),s("span",{style:{color:"#393A34","--s-dark":"#DBD7CAEE"}}," ")]),a(`
`),s("span",{class:"line"})])]),s("p",null,[a("The situation changes when the "),s("code",null,"setup()"),a(" is asynchronous. Whenever you "),s("code",null,"await"),a(" a promise, you can think the engine paused the works here and went to do another task. If we "),s("code",null,"await"),a(" the function, during the time period, multiple components creation will change the global variable unpredictably and end up with a mess.")]),s("pre",{class:"shiki shiki-themes vitesse-light vitesse-dark",style:{"background-color":"#ffffff","--s-dark-bg":"#121212",color:"#393a34","--s-dark":"#dbd7caee"},tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"currentInstance"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ="),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," instance")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}},"await"),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," component"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"."),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"setup"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"()"),s("span",{style:{color:"#A0ADA0","--s-dark":"#758575DD"}}," // atomic lost")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"currentInstance"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ="),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," prev"),s("span",{style:{color:"#393A34","--s-dark":"#DBD7CAEE"}}," ")]),a(`
`),s("span",{class:"line"})])]),s("p",null,[a("If we don’t use "),s("code",null,"await"),a(" to check the instance, calling the "),s("code",null,"setup()"),a(" function will make it finish the tasks before the first "),s("code",null,"await"),a(" statement, and the rest will be executed whenever the "),s("code",null,"await"),a(" statement is resolved.")]),s("div",{class:"grid grid-cols-2 gap-2 lt-sm:grid-cols-1"},[s("pre",{class:"shiki shiki-themes vitesse-light vitesse-dark",style:{"background-color":"#ffffff","--s-dark-bg":"#121212",color:"#393a34","--s-dark":"#dbd7caee"},tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"async"),s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}}," function"),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," setup"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"()"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"  console"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"."),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"log"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"("),s("span",{style:{color:"#2F798A","--s-dark":"#4C9A91"}},"1"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},")")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}},"  await"),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," someAsyncFunction"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"()")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"  console"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"."),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"log"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"("),s("span",{style:{color:"#2F798A","--s-dark":"#4C9A91"}},"2"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},")")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#999999","--s-dark":"#666666"}},"}")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"console"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"."),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"log"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"("),s("span",{style:{color:"#2F798A","--s-dark":"#4C9A91"}},"3"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},")")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"setup"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"()")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"console"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"."),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"log"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"("),s("span",{style:{color:"#2F798A","--s-dark":"#4C9A91"}},"4"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},")")]),a(`
`),s("span",{class:"line"})])]),s("pre",{class:"shiki shiki-themes vitesse-light vitesse-dark",style:{"background-color":"#ffffff","--s-dark-bg":"#121212",color:"#393a34","--s-dark":"#dbd7caee"},tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#A0ADA0","--s-dark":"#758575DD"}},"// output:")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#2F798A","--s-dark":"#4C9A91"}},"3")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#2F798A","--s-dark":"#4C9A91"}},"1")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#2F798A","--s-dark":"#4C9A91"}},"4")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#999999","--s-dark":"#666666"}},"("),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"awaiting"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},")")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#2F798A","--s-dark":"#4C9A91"}},"2")]),a(`
`),s("span",{class:"line"})])])]),s("p",null,"This means, there is no way for Vue to know when will the asynchronous part been called from the outside, so there is also no way to bound the instance to the context."),s("h2",{id:"the-solutions",tabindex:"-1"},[a("The Solutions "),s("a",{class:"header-anchor",href:"#the-solutions","aria-hidden":"true"},"#")]),s("p",null,"This is actually a limitation of JavaScript itself, unless we have some new proposal to open the gate on the language level, we have to live with it."),s("p",null,"But to work around it, I have collected a few solutions for you to choose from based on your needs."),s("h3",{id:"remember-the-caveat-and-avoid-it",tabindex:"-1"},[a("Remember the Caveat and Avoid It "),s("a",{class:"header-anchor",href:"#remember-the-caveat-and-avoid-it","aria-hidden":"true"},"#")]),s("p",null,[a('This is, of course, an obvious "solution". You can try to move your effect and hooks before the first '),s("code",null,"await"),a(" statement and carefully remember not to have them after that again.")]),s("p",null,[a("Luckily, if you are using ESLint, you can have the "),s("a",{href:"https://eslint.vuejs.org/rules/no-watch-after-await.html",target:"_blank",rel:"noopener"},[s("code",null,"vue/no-watch-after-await")]),a(" and "),s("a",{href:"https://eslint.vuejs.org/rules/no-lifecycle-after-await.html",target:"_blank",rel:"noopener"},[s("code",null,"vue/no-lifecycle-after-await")]),a(" rules from "),s("a",{href:"https://eslint.vuejs.org/",target:"_blank",rel:"noopener"},[s("code",null,"eslint-plugin-vue")]),a(" enabled so it could warn you whenever you made some mistakes (they are enabled by default within the plugin presets).")]),s("h3",{id:"wrap-the-async-function-as-reactive-sync",tabindex:"-1"},[a('Wrap the Async Function as "Reactive Sync" '),s("a",{class:"header-anchor",href:"#wrap-the-async-function-as-reactive-sync","aria-hidden":"true"},"#")]),s("p",null,[a("In some situations, your logic might be relying on the data that fetched asynchronously. In this way, you could consider using the "),s("a",{href:"/posts/composable-vue-vueday-2021#async-to-sync"},"trick I have shared on VueDay 2021"),a(" to "),s("strong",null,"turn your async function into a sync reactive state"),a(".")]),s("pre",{class:"shiki shiki-themes vitesse-light vitesse-dark",style:{"background-color":"#ffffff","--s-dark-bg":"#121212",color:"#393a34","--s-dark":"#dbd7caee"},tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"const "),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"data"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ="),s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}}," await"),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," fetch"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"("),s("span",{style:{color:"#B5695999","--s-dark":"#C98A7D99"}},"'"),s("span",{style:{color:"#B56959","--s-dark":"#C98A7D"}},"https://api.github.com/"),s("span",{style:{color:"#B5695999","--s-dark":"#C98A7D99"}},"'"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},")."),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"then"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"("),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"r"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," =>"),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," r"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"."),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"json"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"())")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"const "),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"user"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ="),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," data"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"."),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"user")]),a(`
`),s("span",{class:"line"})])]),s("pre",{class:"shiki shiki-themes vitesse-light vitesse-dark",style:{"background-color":"#ffffff","--s-dark-bg":"#121212",color:"#393a34","--s-dark":"#dbd7caee"},tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"const "),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"data"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ="),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," ref"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"("),s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"null"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},")")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"fetch"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"("),s("span",{style:{color:"#B5695999","--s-dark":"#C98A7D99"}},"'"),s("span",{style:{color:"#B56959","--s-dark":"#C98A7D"}},"https://api.github.com/"),s("span",{style:{color:"#B5695999","--s-dark":"#C98A7D99"}},"'"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},")")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#999999","--s-dark":"#666666"}},"  ."),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"then"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"("),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"r"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," =>"),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," r"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"."),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"json"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"())")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#999999","--s-dark":"#666666"}},"  ."),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"then"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"("),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"res"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," =>"),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," data"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"."),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"value"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ="),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," res"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},")")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"const "),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"user"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ="),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," computed"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"(()"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," =>"),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," data"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"?."),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"user"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},")")]),a(`
`),s("span",{class:"line"})])]),s("p",null,'This approach make the "connections" between your logic to resolve first, and then reactive updates when the asynchronous function get resolved and filled with data.'),s("p",null,[a("There is also some more general utilities for it from "),s("a",{href:"https://vueuse.org/",target:"_blank",rel:"noopener"},"VueUse"),a(":")]),s("h4",{id:"useasyncstate",tabindex:"-1"},[s("a",{href:"https://vueuse.org/useAsyncState",target:"_blank",rel:"noopener"},[s("code",null,"useAsyncState")]),a(),s("a",{class:"header-anchor",href:"#useasyncstate","aria-hidden":"true"},"#")]),s("pre",{class:"shiki shiki-themes vitesse-light vitesse-dark",style:{"background-color":"#ffffff","--s-dark-bg":"#121212",color:"#393a34","--s-dark":"#dbd7caee"},tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}},"import"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," {"),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," useAsyncState"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," }"),s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}}," from"),s("span",{style:{color:"#B5695999","--s-dark":"#C98A7D99"}}," '"),s("span",{style:{color:"#B56959","--s-dark":"#C98A7D"}},"@vueuse/core"),s("span",{style:{color:"#B5695999","--s-dark":"#C98A7D99"}},"'")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"const "),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"{"),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," state"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},","),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," ready"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," }"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ="),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," useAsyncState"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"("),s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"async "),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"()"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," =>"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"  const "),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"{"),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," data"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," }"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ="),s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}}," await"),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," axios"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"."),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"get"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"("),s("span",{style:{color:"#B5695999","--s-dark":"#C98A7D99"}},"'"),s("span",{style:{color:"#B56959","--s-dark":"#C98A7D"}},"https://api.github.com/"),s("span",{style:{color:"#B5695999","--s-dark":"#C98A7D99"}},"'"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},")")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}},"  return"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," { "),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"data"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," }")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#999999","--s-dark":"#666666"}},"})")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"const "),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"user"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ="),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," computed"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"(()"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," =>"),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," state"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"?."),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"user"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},")")]),a(`
`),s("span",{class:"line"})])]),s("h4",{id:"usefetch",tabindex:"-1"},[s("a",{href:"https://vueuse.org/useFetch",target:"_blank",rel:"noopener"},[s("code",null,"useFetch")]),a(),s("a",{class:"header-anchor",href:"#usefetch","aria-hidden":"true"},"#")]),s("pre",{class:"shiki shiki-themes vitesse-light vitesse-dark",style:{"background-color":"#ffffff","--s-dark-bg":"#121212",color:"#393a34","--s-dark":"#dbd7caee"},tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}},"import"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," {"),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," useFetch"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," }"),s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}}," from"),s("span",{style:{color:"#B5695999","--s-dark":"#C98A7D99"}}," '"),s("span",{style:{color:"#B56959","--s-dark":"#C98A7D"}},"@vueuse/core"),s("span",{style:{color:"#B5695999","--s-dark":"#C98A7D99"}},"'")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"const "),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"{"),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," data"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},","),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," isFetching"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},","),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," error"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," }"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ="),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," useFetch"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"("),s("span",{style:{color:"#B5695999","--s-dark":"#C98A7D99"}},"'"),s("span",{style:{color:"#B56959","--s-dark":"#C98A7D"}},"https://api.github.com/"),s("span",{style:{color:"#B5695999","--s-dark":"#C98A7D99"}},"'"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},")")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"const "),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"user"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ="),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," computed"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"(()"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," =>"),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," data"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"?."),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"user"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},")")]),a(`
`),s("span",{class:"line"})])]),s("h3",{id:"explicitly-bound-the-instance",tabindex:"-1"},[a("Explicitly Bound the Instance "),s("a",{class:"header-anchor",href:"#explicitly-bound-the-instance","aria-hidden":"true"},"#")]),s("p",null,"Lifecycle hooks actually accept a second argument for setting the instance explicitly."),s("pre",{class:"shiki shiki-themes vitesse-light vitesse-dark",style:{"background-color":"#ffffff","--s-dark-bg":"#121212",color:"#393a34","--s-dark":"#dbd7caee"},tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}},"export"),s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}}," default"),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," defineAsyncComponent"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"({")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"  async"),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," setup"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"() {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A0ADA0","--s-dark":"#758575DD"}},"    // get and hold the instance before `await`")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"    const "),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"instance"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ="),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," getCurrentInstance"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"()")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}},"    await"),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," someAsyncFunction"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"() "),s("span",{style:{color:"#A0ADA0","--s-dark":"#758575DD"}},"// <-----------")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"    onUnmounted"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"(")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#999999","--s-dark":"#666666"}},"      () => "),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"console"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"."),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"log"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"("),s("span",{style:{color:"#B5695999","--s-dark":"#C98A7D99"}},"'"),s("span",{style:{color:"#B56959","--s-dark":"#C98A7D"}},"Unmounted"),s("span",{style:{color:"#B5695999","--s-dark":"#C98A7D99"}},"'"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"),")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"      instance"),s("span",{style:{color:"#A0ADA0","--s-dark":"#758575DD"}}," // <--- pass the instance to it")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#999999","--s-dark":"#666666"}},"    )")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#999999","--s-dark":"#666666"}},"  }")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#999999","--s-dark":"#666666"}},"})")]),a(`
`),s("span",{class:"line"})])]),s("p",null,[a("However, the downside is that this solution "),s("strong",null,"does not work"),a(" with "),s("code",null,"watch"),a(" / "),s("code",null,"watchEffect"),a(" / "),s("code",null,"computed"),a(" / "),s("code",null,"provide"),a(" / "),s("code",null,"inject"),a(" as they does not accept the instance argument.")]),s("p",null,[a("To get the effects work, you could use the "),s("a",{href:"https://github.com/vuejs/rfcs/blob/master/active-rfcs/0041-reactivity-effect-scope.md",target:"_blank",rel:"noopener"},[s("code",null,"effectScope"),a(" API")]),a(" in the upcoming Vue 3.2.")]),s("pre",{class:"shiki shiki-themes vitesse-light vitesse-dark",style:{"background-color":"#ffffff","--s-dark-bg":"#121212",color:"#393a34","--s-dark":"#dbd7caee"},tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}},"import"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," {"),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," effectScope"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," }"),s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}}," from"),s("span",{style:{color:"#B5695999","--s-dark":"#C98A7D99"}}," '"),s("span",{style:{color:"#B56959","--s-dark":"#C98A7D"}},"vue"),s("span",{style:{color:"#B5695999","--s-dark":"#C98A7D99"}},"'")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}},"export"),s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}}," default"),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," defineAsyncComponent"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"({")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"  async"),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," setup"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"() {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A0ADA0","--s-dark":"#758575DD"}},"    // create the scope before `await`, so it will be bond to the instance")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"    const "),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"scope"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ="),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," effectScope"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"()")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"    const "),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"data"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ="),s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}}," await"),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," someAsyncFunction"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"()"),s("span",{style:{color:"#A0ADA0","--s-dark":"#758575DD"}}," // <-----------")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"    scope"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"."),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"run"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"(() => {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A0ADA0","--s-dark":"#758575DD"}},"      /* Use `computed`, `watch`, etc. ... */")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#999999","--s-dark":"#666666"}},"    })")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A0ADA0","--s-dark":"#758575DD"}},"    // the lifecycle hooks will not be available here,")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A0ADA0","--s-dark":"#758575DD"}},"    // you will need to combine it with the previous snippet")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A0ADA0","--s-dark":"#758575DD"}},"    // to have both lifecycle hooks and effects works.")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#999999","--s-dark":"#666666"}},"  }")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#999999","--s-dark":"#666666"}},"})")]),a(`
`),s("span",{class:"line"})])]),s("h3",{id:"compile-time-magic",tabindex:"-1"},[a("Compile-time Magic! "),s("a",{class:"header-anchor",href:"#compile-time-magic","aria-hidden":"true"},"#")]),s("p",null,[a("In the recent "),s("a",{href:"https://github.com/vuejs/rfcs/blob/master/active-rfcs/0040-script-setup.md",target:"_blank",rel:"noopener"},[s("code",null,"<script setup>"),a(" proposal")]),a(" update, a new "),s("a",{href:"https://github.com/vuejs/rfcs/blob/master/active-rfcs/0040-script-setup.md#top-level-await",target:"_blank",rel:"noopener"},"compile-time magic"),a(" is introduced.")]),s("p",null,[a("The way it works is to inject a script after each "),s("code",null,"await"),a(" statement for restoring the current instance state.")]),s("pre",{class:"shiki shiki-themes vitesse-light vitesse-dark",style:{"background-color":"#ffffff","--s-dark-bg":"#121212",color:"#393a34","--s-dark":"#dbd7caee"},tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#999999","--s-dark":"#666666"}},"<"),s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}},"script"),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," setup"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},">")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"const"),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," post"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ="),s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}}," await"),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," fetch"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"("),s("span",{style:{color:"#B5695999","--s-dark":"#C98A7D99"}},"`"),s("span",{style:{color:"#B56959","--s-dark":"#C98A7D"}},"/api/post/1"),s("span",{style:{color:"#B5695999","--s-dark":"#C98A7D99"}},"`"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},")."),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"then"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"(("),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"r"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},")"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," =>"),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," r"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"."),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"json"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"())")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#999999","--s-dark":"#666666"}},"</"),s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}},"script"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},">")]),a(`
`),s("span",{class:"line"})])]),s("pre",{class:"shiki shiki-themes vitesse-light vitesse-dark",style:{"background-color":"#ffffff","--s-dark-bg":"#121212",color:"#393a34","--s-dark":"#dbd7caee"},tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}},"import"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," {"),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," withAsyncContext"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," }"),s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}}," from"),s("span",{style:{color:"#B5695999","--s-dark":"#C98A7D99"}}," '"),s("span",{style:{color:"#B56959","--s-dark":"#C98A7D"}},"vue"),s("span",{style:{color:"#B5695999","--s-dark":"#C98A7D99"}},"'")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}},"export"),s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}}," default"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"  async"),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," setup"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"()"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"    let"),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," __temp"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},","),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," __restore")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"    const"),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," post"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," =")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#999999","--s-dark":"#666666"}},"      ((["),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"__temp"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},","),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," __restore"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"]"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ="),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," withAsyncContext"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"(()"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," =>")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"        fetch"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"("),s("span",{style:{color:"#B5695999","--s-dark":"#C98A7D99"}},"`"),s("span",{style:{color:"#B56959","--s-dark":"#C98A7D"}},"/api/post/1"),s("span",{style:{color:"#B5695999","--s-dark":"#C98A7D99"}},"`"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},")."),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"then"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"(("),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"r"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},")"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," =>"),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," r"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"."),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"json"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"())")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#999999","--s-dark":"#666666"}},"      )),")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#999999","--s-dark":"#666666"}},"      ("),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"__temp"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ="),s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}}," await"),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," __temp"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"),")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"      __restore"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"(),")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"      __temp"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},")")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A0ADA0","--s-dark":"#758575DD"}},"    // current instance context preserved")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A0ADA0","--s-dark":"#758575DD"}},"    // e.g. onMounted() will still work.")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}},"    return"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," {"),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," post"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," }")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#999999","--s-dark":"#666666"}},"  }")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#999999","--s-dark":"#666666"}},"}")]),a(`
`),s("span",{class:"line"})])]),s("p",null,[a("With it, the async functions will "),s("strong",null,"just work"),a(" when using with "),s("code",null,"<script setup>"),a(". The only shame is it does not work outside of "),s("code",null,"<script setup>"),a(".")])],-1),A={__name:"async-with-composition-api",setup(d){const e={title:"Async with Composition API",description:"Notes about the caveat when using async functions in Vue Composition API.",date:"2021-07-16T08:00:00.000Z",lang:"en",duration:"17min",image:"https://antfu.me/og/async-with-composition-api.png",meta:[{property:"og:title",content:"Async with Composition API"},{name:"twitter:title",content:"Async with Composition API"},{name:"description",content:"Notes about the caveat when using async functions in Vue Composition API."},{property:"og:description",content:"Notes about the caveat when using async functions in Vue Composition API."},{name:"twitter:description",content:"Notes about the caveat when using async functions in Vue Composition API."},{property:"og:image",content:"https://antfu.me/og/async-with-composition-api.png"},{name:"twitter:image",content:"https://antfu.me/og/async-with-composition-api.png"},{name:"twitter:card",content:"summary_large_image"}]};return o({title:"Async with Composition API",meta:[{property:"og:title",content:"Async with Composition API"},{name:"twitter:title",content:"Async with Composition API"},{name:"description",content:"Notes about the caveat when using async functions in Vue Composition API."},{property:"og:description",content:"Notes about the caveat when using async functions in Vue Composition API."},{name:"twitter:description",content:"Notes about the caveat when using async functions in Vue Composition API."},{property:"og:image",content:"https://antfu.me/og/async-with-composition-api.png"},{name:"twitter:image",content:"https://antfu.me/og/async-with-composition-api.png"},{name:"twitter:card",content:"summary_large_image"}]}),(k,y)=>{const l=r;return c(),n(l,{frontmatter:e},{default:t(()=>[p]),_:1})}}};export{A as default};
