import{u as o,c as n,w as r,_ as t,o as c,a as s,d as a}from"./app-b266d4ec.js";const p=s("div",{class:"prose m-auto slide-enter-content"},[s("p",null,[s("code",null,"async"),a(" / "),s("code",null,"await"),a(" in ES7 is truly a life-saver for the JavaScript world. It allows you to avoid "),s("a",{href:"http://callbackhell.com/",target:"_blank",rel:"noopener"},"callback hell"),a(" in your code and make it more readable. However, a common pitfall is that when you "),s("code",null,"await"),a(" a huge asynchronous task that takes very long time, it blocks the following code and could potentially make your app slow.")]),s("p",null,"For example:"),s("pre",{class:"shiki shiki-themes vitesse-light vitesse-dark",style:{"background-color":"#ffffff","--s-dark-bg":"#121212",color:"#393a34","--s-dark":"#dbd7caee"},tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"const "),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"app"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ="),s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}}," await"),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," createServer"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"()")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"const "),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"middlewareA"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ="),s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}}," await"),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," resolveMiddlewareA"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"()")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"const "),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"middlewareB"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ="),s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}}," await"),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," resolveMiddlewareB"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"()")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"app"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"."),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"use"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"("),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"middlewareA"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},")")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"app"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"."),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"use"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"("),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"middlewareB"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},")")]),a(`
`),s("span",{class:"line"})])]),s("p",null,[a("We have used three "),s("code",null,"await"),a(" in the example, while the three async function does not actually relying on each other, having them sequentially we are possibility wasted some time of the operations that could be parallelized (IO, Network, etc.)")]),s("p",null,[a("So we can use "),s("a",{href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/all",target:"_blank",rel:"noopener"},[s("code",null,"Promise.all")]),a(" to optimize the code:")]),s("pre",{class:"shiki shiki-themes vitesse-light vitesse-dark",style:{"background-color":"#ffffff","--s-dark-bg":"#121212",color:"#393a34","--s-dark":"#dbd7caee"},tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"const "),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"["),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"app"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},","),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," middlewareA"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},","),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," middlewareB"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"]"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ="),s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}}," await"),s("span",{style:{color:"#998418","--s-dark":"#B8A965"}}," Promise"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"."),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"all"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"(")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#999999","--s-dark":"#666666"}},"  [")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"    createServer"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"(),")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"    resolveMiddlewareA"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"(),")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"    resolveMiddlewareB"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"(),")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#999999","--s-dark":"#666666"}},"  ],")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#999999","--s-dark":"#666666"}},")")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"app"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"."),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"use"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"("),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"middlewareA"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},")")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"app"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"."),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"use"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"("),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"middlewareB"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},")")]),a(`
`),s("span",{class:"line"})])]),s("p",null,"In another example, you might relying on the async result, but sometime not that urgent:"),s("pre",{class:"shiki shiki-themes vitesse-light vitesse-dark",style:{"background-color":"#ffffff","--s-dark-bg":"#121212",color:"#393a34","--s-dark":"#dbd7caee"},tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"async"),s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}}," function"),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," createPlugin"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"()"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"  const "),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"toolkit"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ="),s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}}," await"),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," initToolKit"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"()")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}},"  return"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"    onHookA"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"() {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"      toolkit"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"."),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"invokeA"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"()")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#999999","--s-dark":"#666666"}},"    },")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"    onHookB"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"() {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"      toolkit"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"."),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"invokeB"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"()")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#999999","--s-dark":"#666666"}},"    },")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#999999","--s-dark":"#666666"}},"  }")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#999999","--s-dark":"#666666"}},"}")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"const "),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"plugin"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ="),s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}}," await"),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," createPlugin"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"()")]),a(`
`),s("span",{class:"line"})])]),s("p",null,[a("Even though you donâ€™t need "),s("code",null,"toolkit"),a(" immediately, you are still forced to use "),s("code",null,"async function"),a(" because the "),s("code",null,"initToolKit"),a(" is async. To avoid this, we could make the promise been resolved in the hooks instead")]),s("pre",{class:"shiki shiki-themes vitesse-light vitesse-dark",style:{"background-color":"#ffffff","--s-dark-bg":"#121212",color:"#393a34","--s-dark":"#dbd7caee"},tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"function"),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," createPlugin"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"()"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"  const "),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"toolkitPromise"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ="),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," initToolKit"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"()")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}},"  return"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"    async"),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," onHookA"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"() {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"      const "),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"toolkit"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ="),s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}}," await"),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," toolkitPromise")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"      toolkit"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"."),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"invokeA"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"()")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#999999","--s-dark":"#666666"}},"    },")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"    async"),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," onHookB"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"() {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"      const "),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"toolkit"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ="),s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}}," await"),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," toolkitPromise")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"      toolkit"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"."),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"invokeB"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"()")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#999999","--s-dark":"#666666"}},"    },")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#999999","--s-dark":"#666666"}},"  }")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#999999","--s-dark":"#666666"}},"}")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A0ADA0","--s-dark":"#758575DD"}},"// now it's sync!")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"const "),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"plugin"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ="),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," createPlugin"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"()")]),a(`
`),s("span",{class:"line"})])]),s("p",null,[a("Since a Promise could only "),s("a",{href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise#description",target:"_blank",rel:"noopener"},"be resolved once"),a(", using multiple "),s("code",null,"await"),a(" for a single Promise instance is "),s("a",{href:"https://blog.ashleygrant.com/2020/04/30/resolved-javascript-promises-can-be-used-multiple-times/",target:"_blank",rel:"noopener"},"totally fine"),a(" - it will return the resolved result immediate if the Promise is allready settled.")]),s("p",null,"To be more generalized, we could have an utility function like:"),s("pre",{class:"shiki shiki-themes vitesse-light vitesse-dark",style:{"background-color":"#ffffff","--s-dark-bg":"#121212",color:"#393a34","--s-dark":"#dbd7caee"},tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}},"export"),s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}}," function"),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," createSingletonPromise"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"<"),s("span",{style:{color:"#2E8F82","--s-dark":"#5DA994"}},"T"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},">("),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}},"fn"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},": () => "),s("span",{style:{color:"#2E8F82","--s-dark":"#5DA994"}},"Promise"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"<"),s("span",{style:{color:"#2E8F82","--s-dark":"#5DA994"}},"T"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},">)"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"  let "),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"_promise"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},": "),s("span",{style:{color:"#2E8F82","--s-dark":"#5DA994"}},"Promise"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"<"),s("span",{style:{color:"#2E8F82","--s-dark":"#5DA994"}},"T"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"> | "),s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"undefined")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}},"  return"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ()"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," =>"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}},"    if"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ("),s("span",{style:{color:"#AB5959","--s-dark":"#CB7676"}},"!"),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"_promise"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},")")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}},"      _promise"),s("span",{style:{color:"#999999","--s-dark":"#666666"}}," ="),s("span",{style:{color:"#59873A","--s-dark":"#80A665"}}," fn"),s("span",{style:{color:"#999999","--s-dark":"#666666"}},"()")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#1E754F","--s-dark":"#4D9375"}},"    return"),s("span",{style:{color:"#B07D48","--s-dark":"#BD976A"}}," _promise")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#999999","--s-dark":"#666666"}},"  }")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#999999","--s-dark":"#666666"}},"}")]),a(`
`),s("span",{class:"line"})])]),s("p",null,[a("This function is also available in my utilities collection "),s("a",{href:"https://github.com/antfu/utils",target:"_blank",rel:"noopener"},[s("code",null,"@antfu/utils")])])],-1),B={__name:"optimize-await",setup(i){const l={title:"Optimize Await",date:"2021-07-01T16:00:00.000Z",lang:"en",duration:"8min",type:"note",image:"https://antfu.me/og/optimize-await.png",meta:[{property:"og:title",content:"Optimize Await"},{name:"twitter:title",content:"Optimize Await"},{property:"og:image",content:"https://antfu.me/og/optimize-await.png"},{name:"twitter:image",content:"https://antfu.me/og/optimize-await.png"},{name:"twitter:card",content:"summary_large_image"}]};return o({title:"Optimize Await",meta:[{property:"og:title",content:"Optimize Await"},{name:"twitter:title",content:"Optimize Await"},{property:"og:image",content:"https://antfu.me/og/optimize-await.png"},{name:"twitter:image",content:"https://antfu.me/og/optimize-await.png"},{name:"twitter:card",content:"summary_large_image"}]}),(k,y)=>{const e=t;return c(),n(e,{frontmatter:l},{default:r(()=>[p]),_:1})}}};export{B as default};
